{% extends 'admin_base.html' %}
{%load static%}

{% block admin_base %}
<div class="container-fluid">
    <div class="col-md-10 mx-auto card mt-3 p-5 shadow shadow-sm ">
        <h3>Publish newspaper</h3>
        <br>
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="">Date/Time</label>
                        <input type="text" id="date" value="{{today_date}}" pattern="\d{1,2}-\d{1,2}-\d{4}" placeholder="dd-mm-yyyy" class="datepicker form-control" name="date" value="{{city.newsDate}}" />
        
                    </div>
    
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="">State</label>
                        <select class="ui js-example-templating " style="width: 100%;" id="stateId" name="stateId" onchange="get_companies();">
                                <option value="">-- Select State --</option>
                            {% for state in states %}
                                <option value="{{state.stateId}}">{{state.stateName}}</option>
                            {% endfor %}  
                          </select>
        
                    </div>
    
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="">Publication House</label>
                        <select name="companyId" id="companyId" class="ui js-example-templating form-control " style="width: 100%;" onchange="get_cities();">
                            <option value="">-- Select Company --</option>
                        </select>
        
                    </div>
    
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="">Sort</label>
                        <select name="" id="sort" class="ui  form-control " style="width: 100%;" onchange="get_cities();">
                            <option value="0">Acending</option>
                            <option value="1">Decending</option>
                        </select>
        
                    </div>
    
                </div>

            </div>
            <h5 class="mt-3">MAIN UPLOAD</h5>
                <br>
            <div class="row">
                
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="" >File Name</label>
                        <div id="info"></div>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" name="main_file" id="main_file" onchange="upload_main();">
                            <label class="custom-file-label" for="customFile">Choose file</label>
                        </div>
        
        
                    </div>
    
    
                </div>
                <div class="col-md-6">
                    <!-- <div class="form-group">
                        <label for="" >Multiple File</label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" multiple data-show-upload="true" data-show-caption="true">
                            <label class="custom-file-label" for="customFile" >Choose file</label>
                        </div>
        
        
                    </div> -->
    
    
                </div>

            </div>
            <h5 class="mt-3">UPLOAD FOR CITY</h5>
                <br>
                <div class="row" id="district_row">
                    
                    
                    

                </div>
            <!-- <input type="submit" value="Add" class="form-control btn btn-success mb-5 mt-3"> -->
            
        

        

    </div>

</div>
<!-- for select search  -->
<script>
    function formatState (state) {
        if (!state.id) {
            return state.text;
        }

        var baseUrl = "/user/pages/images/flags";
        var $state = $(
            '<span><img class="img-flag" /> <span></span></span>'
        );

        // Use .text() instead of HTML string concatenation to avoid script injection issues
        $state.find("span").text(state.text);
        // $state.find("img").attr("src", baseUrl + "/" + state.element.value.toLowerCase() + ".png");

        return $state;
        };

        $(".js-example-templating").select2({
        templateSelection: formatState,
        theme: "bootstrap4",
        
        });
</script>

<script>
    $(document).ready(function () {
    $('.datepicker').datepicker({
      uiLibrary: 'bootstrap4',
      format: 'dd-mm-yyyy'
    });
});
</script>

<script>
    function get_companies(){
        state_id = $("#stateId").val();
        $.ajax({
            url:"{% url 'get_companies' %}",
            type:"get",
            data:{state_id:state_id},
            success:function(data){
                let r = '<option value="">--Select Company--</option>'
                for(i=0; i<data["companies"].length; i++){
                    
                    r += '<option value="'+data["companies"][i]["companyId"]+'">'+data["companies"][i]["companyName"]+'</option>'
                    
                }
                $("#companyId").html(r);
            }
        })
    }
</script>

<script>
    function get_cities(){
        company_id = $("#companyId").val();
        sort = $("#sort").val();
        date = $("#date").val();
        $.ajax({
            url:"{% url 'get_cities' %}",
            type:"get",
            data:{company_id:company_id,
                    date:date,
                    sort:sort},
            success:function(data){
                if(data["companyId"]==company_id){
                    $("#info").html('<h6 class="text-right text-success"><i class="fas fa-check"></i> UPLOADED - '+data["date"]+'</h6>');
                }
                else{
                    $("#info").html('');
                }
                let r = ""
                for(i=0; i<data["district_list"].length; i++){
                    r += '<div class="col-md-4 card p-3 city">'
                    r += '<h5 style="color: rgb(121, 41, 158);" class="text-center">'+data["district_list"][i]+'</h5>'
                    r += '<input type="text" hidden value="'+data["district_list"][i]+'" id="cityName'+i+'" name="cityName">'
                    r += '<div class="form-group">'
                    r += '<input type="file" name="city_file" id="city_file'+i+'" class="mt-3" onchange="city_upload('+i+');"><br>'
                    r += '<br><span id=city_info'+i+'>'
                    for(j=0;j<data["added_city"].length;j++){
                        if(data["district_list"][i]==data["added_city"][j]){
                            r += '<br><h6 class="text-success"><i class="fas fa-check"></i> UPLOADED - '+data["date"]+'</h6>'
                        }
                        else{
                            r += ''
                        }
                    }
                    r += '</span>'
                    r += '</div></div>'   
                 }
                $("#district_row").html(r);
            }
        })
    }
</script>

<script>
    function upload_main(){
        main_file = $("#main_file").prop('files')[0];       
        companyId = $("#companyId").val();
        stateId = $("#stateId").val();
        date = $("#date").val();
        var fd = new FormData();    
        fd.append( 'main_file', $("#main_file").prop('files')[0] );
        fd.append( 'companyId', companyId );
        fd.append( 'date', date );
        fd.append('stateId',stateId);
        $.ajax({
            url:"{% url 'upload_main' %}",
            data: fd,
            processData: false,
            contentType: false,
            type:"POST",
            success:function(data){
                if(data["status"]=="success"){
                    $("#info").html('<h6 class="text-right text-success"><i class="fas fa-check"></i> UPLOADED - '+data["msg"]+'</h6>');
                }
                else{
                    $("#info").html('<h6 class="text-right text-danger"><i class="fas fa-times"></i> '+data["msg"]+'</h6>');
                }
            }
        })
    }

   
</script>


<script>
    
    function city_upload(i){
        city_file = $("#city_file"+i).prop("files")[0];       
        cityName = $("#cityName"+i).val();
        date = $("#date").val();
        stateId = $("#stateId").val();
        companyId = $("#companyId").val();
        var fd = new FormData();    
        fd.append( "city_file", $("#city_file"+i).prop("files")[0] );
        fd.append( "cityName", cityName );
        fd.append( "date", date );
        fd.append( 'companyId', companyId );
        fd.append('stateId',stateId);
        $.ajax({
            url:"{% url 'city_upload' %}",
            data: fd,
            processData: false,
            contentType: false,
            type:"POST",
            success:function(data){
                if(data["status"]=="success"){
                    $("#city_info"+i).html('<br><h6 class="text-success"><i class="fas fa-check"></i> UPLOADED - '+data["msg"]+'</h6>');
                }
                else{
                    $("#city_info"+i).html('<br><h6 class="text-danger"><i class="fas fa-times"></i> '+data["msg"]+'</h6>');
                }
            }
        })
    }
</script>

{%endblock%}